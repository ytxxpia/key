<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡çœ çŠ¶æ€ä¾¦æµ‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }

        .control-panel {
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #4285f4;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #3367d6;
        }

        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        .status-display {
            font-size: 18px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 5px;
            background: #eee;
            min-width: 200px;
            text-align: center;
        }

        .waveform-container {
            height: 200px;
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        #waveform {
            width: 100%;
            height: 100%;
        }

        .timeline-container {
            margin-top: 30px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .timeline {
            display: flex;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .time-block {
            flex: 1;
            border-right: 1px solid #eee;
            position: relative;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .time-block:last-child {
            border-right: none;
        }

        .time-block:hover {
            opacity: 0.8;
        }

        .time-block .tooltip {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            display: none;
            white-space: nowrap;
            z-index: 10;
        }

        .time-block:hover .tooltip {
            display: block;
        }

        /* ç¡çœ çŠ¶æ€é¢œè‰²å®šä¹‰ */
        .awake { background-color: #ffcc00; } /* è‹é†’-é»„è‰² */
        .asleep { background-color: #4b0082; } /* ç¡ç€-æ·±ç´«è‰² */
        .light-sleep { background-color: #9370db; } /* æµ…ç¡-æµ…ç´«è‰² */
        .detecting { background-color: #ff0000; } /* æ£€æµ‹ä¸­-çº¢è‰² */

        .stats {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç¡çœ çŠ¶æ€ä¾¦æµ‹ç³»ç»Ÿ</h1>

        <div class="control-panel">
            <button id="startBtn">å¼€å§‹ä¾¦æµ‹</button>
            <button id="stopBtn" disabled>åœæ­¢ä¾¦æµ‹</button>
            <div class="status-display" id="statusDisplay">æœªå¼€å§‹</div>
        </div>

        <div class="waveform-container">
            <canvas id="waveform"></canvas>
        </div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-label">å½“å‰æ³¢å³°æ•°/åˆ†é’Ÿ</div>
                <div class="stat-value" id="peakCount">0</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">å½“å‰ç¡çœ çŠ¶æ€</div>
                <div class="stat-value" id="sleepState">æœªæ£€æµ‹</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">ä¾¦æµ‹æ—¶é•¿</div>
                <div class="stat-value" id="detectTime">00:00:00</div>
            </div>
        </div>

        <div class="timeline-container">
            <div class="timeline-header">
                <span>ç¡çœ çŠ¶æ€æ—¶é—´è½´ (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</span>
                <span>å›¾ä¾‹: ğŸŸ¡è‹é†’ | ğŸŸ£æ·±ç¡ | ğŸŸªæµ…ç¡ | ğŸ”´æ£€æµ‹ä¸­</span>
            </div>
            <div class="timeline" id="timeline"></div>
        </div>
    </div>

    <script>
        // æ ¸å¿ƒå˜é‡å®šä¹‰
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let canvas;
        let ctx;
        let isDetecting = false;
        let peakCount = 0;          // æ¯åˆ†é’Ÿæ³¢å³°æ•°
        let peakBuffer = [];        // æ³¢å³°æ£€æµ‹ç¼“å­˜
        let detectStartTime;        // ä¾¦æµ‹å¼€å§‹æ—¶é—´
        let detectTimer;            // ä¾¦æµ‹å®šæ—¶å™¨
        let timelineBlocks = [];    // æ—¶é—´è½´å—æ•°ç»„
        let currentState = 'detecting'; // å½“å‰çŠ¶æ€: detecting/awake/asleep/light-sleep
        let wavePeakHistory = [];   // æ³¢å³°é«˜åº¦å†å²ï¼Œç”¨äºåˆ¤æ–­æµ…ç¡

        // DOMå…ƒç´ 
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusDisplay = document.getElementById('statusDisplay');
        const peakCountEl = document.getElementById('peakCount');
        const sleepStateEl = document.getElementById('sleepState');
        const detectTimeEl = document.getElementById('detectTime');
        const timeline = document.getElementById('timeline');
        const waveformCanvas = document.getElementById('waveform');

        // åˆå§‹åŒ–ç”»å¸ƒ
        function initCanvas() {
            canvas = waveformCanvas;
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx = canvas.getContext('2d');
        }

        // è·å–éº¦å…‹é£æƒé™å¹¶åˆå§‹åŒ–éŸ³é¢‘åˆ†æ
        async function initMicrophone() {
            try {
                // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 1024; // FFTå¤§å°ï¼Œå½±å“é¢‘ç‡åˆ†è¾¨ç‡
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                // è·å–éº¦å…‹é£æµ
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: false
                });

                // è¿æ¥éº¦å…‹é£åˆ°åˆ†æå™¨
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                return true;
            } catch (error) {
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼š' + error.message);
                console.error('éº¦å…‹é£åˆå§‹åŒ–å¤±è´¥:', error);
                return false;
            }
        }

        // ç»˜åˆ¶å£°éŸ³æ³¢å½¢
        function drawWaveform() {
            if (!isDetecting) return;

            requestAnimationFrame(drawWaveform);
            
            // è·å–éŸ³é¢‘æ•°æ®
            analyser.getByteTimeDomainData(dataArray);
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // è®¾ç½®æ³¢å½¢æ ·å¼
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#4285f4';
            ctx.beginPath();
            
            const sliceWidth = canvas.width / dataArray.length;
            let x = 0;
            
            // ç»˜åˆ¶æ³¢å½¢
            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i] / 128.0; // å½’ä¸€åŒ–åˆ°0-2
                const y = v * canvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.stroke();
            
            // æ£€æµ‹æ³¢å³°
            detectPeaks();
        }

        // æ³¢å³°æ£€æµ‹é€»è¾‘
        function detectPeaks() {
            // æ³¢å³°é˜ˆå€¼ï¼ˆè¿‡æ»¤èƒŒæ™¯å™ªéŸ³ï¼‰
            const peakThreshold = 150; // 0-255èŒƒå›´
            let isPeak = false;
            
            // æ‰¾åˆ°å½“å‰å¸§çš„æœ€å¤§å€¼
            const maxValue = Math.max(...dataArray);
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºæœ‰æ•ˆæ³¢å³°ï¼ˆè¶…è¿‡é˜ˆå€¼ä¸”æ˜¯å±€éƒ¨æœ€å¤§å€¼ï¼‰
            if (maxValue > peakThreshold) {
                // ç®€å•çš„æ³¢å³°åˆ¤å®šï¼šå½“å‰æœ€å¤§å€¼è¶…è¿‡é˜ˆå€¼ï¼Œä¸”ä¸å‰ä¸€å¸§æœ‰æ˜æ˜¾å˜åŒ–
                const now = Date.now();
                peakBuffer.push({
                    time: now,
                    value: maxValue
                });
                
                // åªä¿ç•™1åˆ†é’Ÿå†…çš„æ³¢å³°æ•°æ®
                peakBuffer = peakBuffer.filter(item => now - item.time < 60000);
                
                // è®¡ç®—æ¯åˆ†é’Ÿæ³¢å³°æ•°
                peakCount = peakBuffer.length;
                peakCountEl.textContent = peakCount;
                
                // è®°å½•æ³¢å³°é«˜åº¦ç”¨äºæµ…ç¡åˆ¤æ–­
                wavePeakHistory.push(maxValue);
                if (wavePeakHistory.length > 60) {
                    wavePeakHistory.shift(); // åªä¿ç•™æœ€è¿‘60ä¸ªæ³¢å³°é«˜åº¦
                }
            }
        }

        // åˆ¤æ–­ç¡çœ çŠ¶æ€
        function judgeSleepState() {
            if (!isDetecting) return;
            
            // 1. è®¡ç®—æ³¢å³°é«˜åº¦çš„å˜å¼‚ç³»æ•°ï¼ˆåˆ¤æ–­æ˜¯å¦ä¸è§„åˆ™ï¼‰
            const heightVariance = calculateVariance(wavePeakHistory);
            const isIrregular = heightVariance > 500; // å˜å¼‚ç³»æ•°é˜ˆå€¼ï¼Œå¯è°ƒæ•´
            const isHighPeak = peakCount > 20 && peakCount < 40 && wavePeakHistory.some(h => h > 180);
            
            // 2. æ ¸å¿ƒçŠ¶æ€åˆ¤æ–­é€»è¾‘
            if (peakCount >= 40) {
                // æ³¢å³°å¤šï¼ˆ40+/åˆ†é’Ÿï¼‰â†’ è‹é†’
                currentState = 'awake';
                sleepStateEl.textContent = 'è‹é†’';
            } else if (peakCount <= 20) {
                // æ³¢å³°å°‘ï¼ˆ20-/åˆ†é’Ÿï¼‰â†’ ç¡ç€
                currentState = 'asleep';
                sleepStateEl.textContent = 'ç¡ç€';
            } else if (isHighPeak && isIrregular) {
                // æ³¢å³°ä¸­ç­‰ä½†é«˜åº¦é«˜ä¸”ä¸è§„åˆ™ â†’ æµ…ç¡
                currentState = 'light-sleep';
                sleepStateEl.textContent = 'æµ…ç¡';
            } else {
                // æ£€æµ‹ä¸­/æœªç¡®å®š
                currentState = 'detecting';
                sleepStateEl.textContent = 'æ£€æµ‹ä¸­';
            }
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºæ ·å¼
            updateStatusDisplay();
            
            // æ›´æ–°æ—¶é—´è½´
            updateTimeline();
        }

        // è®¡ç®—æ•°ç»„å˜å¼‚ç³»æ•°ï¼ˆç”¨äºåˆ¤æ–­æ³¢å³°æ˜¯å¦ä¸è§„åˆ™ï¼‰
        function calculateVariance(arr) {
            if (arr.length < 2) return 0;
            
            // è®¡ç®—å¹³å‡å€¼
            const avg = arr.reduce((sum, val) => sum + val, 0) / arr.length;
            
            // è®¡ç®—æ–¹å·®
            const variance = arr.reduce((sum, val) => sum + Math.pow(val - avg, 2), 0) / arr.length;
            
            return variance;
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºæ ·å¼
        function updateStatusDisplay() {
            statusDisplay.textContent = {
                'detecting': 'æ£€æµ‹ä¸­',
                'awake': 'è‹é†’',
                'asleep': 'ç¡ç€',
                'light-sleep': 'æµ…ç¡'
            }[currentState];
            
            statusDisplay.className = 'status-display';
            statusDisplay.classList.add(currentState);
        }

        // æ›´æ–°æ—¶é—´è½´
        function updateTimeline() {
            // æ¯30ç§’åˆ›å»ºä¸€ä¸ªæ—¶é—´å—ï¼ˆå¯è°ƒæ•´ç²’åº¦ï¼‰
            const now = Date.now();
            const minutes = Math.floor((now - detectStartTime) / 60000);
            const blockIndex = Math.floor((now - detectStartTime) / 30000);
            
            // å¦‚æœéœ€è¦æ–°çš„æ—¶é—´å—
            if (blockIndex >= timelineBlocks.length) {
                const block = document.createElement('div');
                block.className = `time-block ${currentState}`;
                block.dataset.time = new Date(detectStartTime + blockIndex * 30000).toLocaleTimeString();
                block.dataset.state = currentState;
                
                // æ·»åŠ æç¤ºæ¡†
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = `${block.dataset.time} - ${getStatusName(currentState)}`;
                block.appendChild(tooltip);
                
                // ç‚¹å‡»äº‹ä»¶ï¼šæ˜¾ç¤ºè¯¦æƒ…
                block.addEventListener('click', () => {
                    alert(`æ—¶é—´ï¼š${block.dataset.time}\nçŠ¶æ€ï¼š${getStatusName(block.dataset.state)}`);
                });
                
                // è§¦ç¢°åˆ¤å®šï¼šç‚¹å‡»æ—¶é—´è½´æ ‡è®°ä¸ºè‹é†’
                block.addEventListener('touchstart', () => {
                    block.className = 'time-block awake';
                    block.dataset.state = 'awake';
                    tooltip.textContent = `${block.dataset.time} - è‹é†’ï¼ˆæ‰‹åŠ¨æ ‡è®°ï¼‰`;
                    currentState = 'awake';
                    updateStatusDisplay();
                });
                
                timeline.appendChild(block);
                timelineBlocks.push(block);
            } else {
                // æ›´æ–°ç°æœ‰æ—¶é—´å—çŠ¶æ€
                const block = timelineBlocks[blockIndex];
                block.className = `time-block ${currentState}`;
                block.dataset.state = currentState;
                block.querySelector('.tooltip').textContent = `${block.dataset.time} - ${getStatusName(currentState)}`;
            }
        }

        // è·å–çŠ¶æ€åç§°
        function getStatusName(state) {
            return {
                'detecting': 'æ£€æµ‹ä¸­',
                'awake': 'è‹é†’',
                'asleep': 'ç¡ç€',
                'light-sleep': 'æµ…ç¡'
            }[state] || 'æœªçŸ¥';
        }

        // æ›´æ–°ä¾¦æµ‹æ—¶é•¿
        function updateDetectTime() {
            if (!isDetecting) return;
            
            const now = Date.now();
            const diff = Math.floor((now - detectStartTime) / 1000);
            
            const hours = String(Math.floor(diff / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
            const seconds = String(diff % 60).padStart(2, '0');
            
            detectTimeEl.textContent = `${hours}:${minutes}:${seconds}`;
        }

        // å¼€å§‹ä¾¦æµ‹
        async function startDetection() {
            // åˆå§‹åŒ–ç”»å¸ƒ
            initCanvas();
            
            // è·å–éº¦å…‹é£æƒé™
            const micInited = await initMicrophone();
            if (!micInited) return;
            
            // é‡ç½®çŠ¶æ€
            isDetecting = true;
            peakCount = 0;
            peakBuffer = [];
            wavePeakHistory = [];
            detectStartTime = Date.now();
            timelineBlocks = [];
            timeline.innerHTML = '';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            // å¼€å§‹ç»˜åˆ¶æ³¢å½¢
            drawWaveform();
            
            // å¯åŠ¨çŠ¶æ€åˆ¤æ–­å®šæ—¶å™¨ï¼ˆæ¯ç§’åˆ¤æ–­ä¸€æ¬¡ï¼‰
            detectTimer = setInterval(() => {
                judgeSleepState();
                updateDetectTime();
            }, 1000);
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            currentState = 'detecting';
            updateStatusDisplay();
        }

        // åœæ­¢ä¾¦æµ‹
        function stopDetection() {
            isDetecting = false;
            
            // å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡
            if (audioContext) {
                audioContext.close();
            }
            
            // æ¸…é™¤å®šæ—¶å™¨
            clearInterval(detectTimer);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            statusDisplay.textContent = 'å·²åœæ­¢';
            statusDisplay.className = 'status-display';
        }

        // é¡µé¢è§¦ç¢°äº‹ä»¶ï¼šæ ‡è®°ä¸ºè‹é†’
        document.addEventListener('click', (e) => {
            if (isDetecting && e.target.closest('.container')) {
                currentState = 'awake';
                updateStatusDisplay();
                // ç«‹å³æ›´æ–°æ—¶é—´è½´
                updateTimeline();
            }
        });

        // ç»‘å®šæŒ‰é’®äº‹ä»¶
        startBtn.addEventListener('click', startDetection);
        stopBtn.addEventListener('click', stopDetection);

        // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°åˆå§‹åŒ–ç”»å¸ƒ
        window.addEventListener('resize', initCanvas);

        // åˆå§‹åŒ–
        initCanvas();
    </script>
</body>
</html>
