<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½ç¡çœ ç›‘æµ‹ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00b4db, #0083b0);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.8;
        }
        
        .control-panel {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        #startBtn {
            background: linear-gradient(90deg, #00b09b, #96c93d);
            color: white;
        }
        
        #stopBtn {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            flex: 1;
            min-width: 200px;
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .status-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #a5b1c2;
        }
        
        .status-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        #currentStatus {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .visualization {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        #sleepTimeline {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .timeline-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .details-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .details-panel h3 {
            margin-bottom: 15px;
            font-size: 1.5rem;
            color: #74b9ff;
            border-bottom: 2px solid rgba(116, 185, 255, 0.3);
            padding-bottom: 10px;
        }
        
        #detailsContent {
            min-height: 100px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .audio-wave {
            height: 100px;
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .wave-visual {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .recording {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .control-panel, .status-display {
                flex-direction: column;
                align-items: center;
            }
            
            .status-card {
                width: 100%;
            }
            
            h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒ™ æ™ºèƒ½ç¡çœ ç›‘æµ‹ç³»ç»Ÿ</h1>
            <p class="subtitle">ä½¿ç”¨éº¦å…‹é£åˆ†æå£°éŸ³é¢‘ç‡ï¼Œå®æ—¶ç›‘æµ‹æ‚¨çš„ç¡çœ çŠ¶æ€</p>
        </header>
        
        <div class="control-panel">
            <button id="startBtn">å¼€å§‹ç›‘æµ‹</button>
            <button id="stopBtn" disabled>åœæ­¢ç›‘æµ‹</button>
        </div>
        
        <div class="status-display">
            <div class="status-card">
                <h3>å½“å‰çŠ¶æ€</h3>
                <div id="currentStatus" class="status-value">æœªå¼€å§‹</div>
            </div>
            <div class="status-card">
                <h3>æ³¢å³°é¢‘ç‡</h3>
                <div id="peakFrequency" class="status-value">0 /åˆ†é’Ÿ</div>
            </div>
            <div class="status-card">
                <h3>ç›‘æµ‹æ—¶é•¿</h3>
                <div id="monitorTime" class="status-value">00:00:00</div>
            </div>
            <div class="status-card">
                <h3>å£°éŸ³å¼ºåº¦</h3>
                <div id="soundLevel" class="status-value">0%</div>
            </div>
        </div>
        
        <div class="audio-wave">
            <canvas id="waveCanvas" class="wave-visual"></canvas>
        </div>
        
        <div class="visualization">
            <h3 style="margin-bottom: 15px; color: #74b9ff;">ç¡çœ æ—¶é—´è½´</h3>
            <div id="sleepTimeline">
                <div class="timeline-label">æ—¶é—´çº¿ â†’</div>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ff4757;"></div>
                    <span>ç›‘æµ‹ä¸­/æœªè¯†åˆ«</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #ffa502;"></div>
                    <span>è‹é†’çŠ¶æ€</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #6c5ce7;"></div>
                    <span>æµ…ç¡çŠ¶æ€</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2d3436;"></div>
                    <span>æ·±ç¡çŠ¶æ€</span>
                </div>
            </div>
        </div>
        
        <div class="details-panel">
            <h3>çŠ¶æ€è¯¦æƒ…</h3>
            <div id="detailsContent">
                ç‚¹å‡»ä¸Šæ–¹æ—¶é—´è½´çš„ä¸åŒé¢œè‰²åŒºåŸŸï¼ŒæŸ¥çœ‹è¯¦ç»†çš„ç¡çœ çŠ¶æ€ä¿¡æ¯ã€‚
            </div>
        </div>
    </div>

    <script>
        // çŠ¶æ€å¸¸é‡
        const STATUS = {
            UNKNOWN: { name: 'æœªè¯†åˆ«', color: '#ff4757' },
            AWAKE: { name: 'è‹é†’', color: '#ffa502' },
            LIGHT_SLEEP: { name: 'æµ…ç¡', color: '#6c5ce7' },
            DEEP_SLEEP: { name: 'æ·±ç¡', color: '#2d3436' }
        };

        // å…¨å±€å˜é‡
        let audioContext;
        let analyser;
        let microphone;
        let isRecording = false;
        let startTime;
        let timerInterval;
        let peaksPerMinute = 0;
        let peakCount = 0;
        let lastMinutePeaks = [];
        let sleepSegments = [];
        let currentSegment = null;
        let touchDetected = false;

        // DOMå…ƒç´ 
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const currentStatusEl = document.getElementById('currentStatus');
        const peakFrequencyEl = document.getElementById('peakFrequency');
        const monitorTimeEl = document.getElementById('monitorTime');
        const soundLevelEl = document.getElementById('soundLevel');
        const waveCanvas = document.getElementById('waveCanvas');
        const sleepTimeline = document.getElementById('sleepTimeline');
        const detailsContent = document.getElementById('detailsContent');

        // åˆå§‹åŒ–ç”»å¸ƒ
        const ctx = waveCanvas.getContext('2d');
        waveCanvas.width = waveCanvas.parentElement.clientWidth;
        waveCanvas.height = waveCanvas.parentElement.clientHeight;

        // æ—¶é—´è½´ç”»å¸ƒ
        const timelineCtx = document.createElement('canvas').getContext('2d');
        timelineCtx.canvas.width = sleepTimeline.clientWidth;
        timelineCtx.canvas.height = sleepTimeline.clientHeight;
        sleepTimeline.appendChild(timelineCtx.canvas);

        // è°ƒæ•´ç”»å¸ƒå¤§å°
        window.addEventListener('resize', () => {
            waveCanvas.width = waveCanvas.parentElement.clientWidth;
            waveCanvas.height = waveCanvas.parentElement.clientHeight;
            
            timelineCtx.canvas.width = sleepTimeline.clientWidth;
            timelineCtx.canvas.height = sleepTimeline.clientHeight;
            renderTimeline();
        });

        // å¼€å§‹ç›‘æµ‹
        startBtn.addEventListener('click', async () => {
            try {
                // è¯·æ±‚éº¦å…‹é£æƒé™
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                // é…ç½®åˆ†æå™¨
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                microphone.connect(analyser);
                
                // å¼€å§‹ç›‘æµ‹
                isRecording = true;
                startTime = Date.now();
                startTimer();
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                startBtn.disabled = true;
                stopBtn.disabled = false;
                
                // è®¾ç½®çŠ¶æ€
                currentStatusEl.textContent = STATUS.UNKNOWN.name;
                currentStatusEl.style.background = 'linear-gradient(90deg, #ff4757, #ff6b81)';
                startBtn.classList.add('recording');
                
                // å¼€å§‹åˆ†æéŸ³é¢‘
                analyzeAudio();
                
                // åˆ›å»ºç¬¬ä¸€ä¸ªæ—¶é—´ç‰‡æ®µ
                currentSegment = {
                    startTime: Date.now(),
                    status: STATUS.UNKNOWN,
                    peaks: []
                };
                
            } catch (error) {
                console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·ç¡®ä¿å·²æˆäºˆéº¦å…‹é£æƒé™ã€‚');
            }
        });

        // åœæ­¢ç›‘æµ‹
        stopBtn.addEventListener('click', () => {
            isRecording = false;
            
            // åœæ­¢æ‰€æœ‰éŸ³é¢‘å¤„ç†
            if (audioContext) {
                audioContext.close();
            }
            
            // æ¸…é™¤è®¡æ—¶å™¨
            clearInterval(timerInterval);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            startBtn.disabled = false;
            stopBtn.disabled = true;
            startBtn.classList.remove('recording');
            
            // ä¿å­˜æœ€åä¸€ä¸ªç‰‡æ®µ
            if (currentSegment) {
                currentSegment.endTime = Date.now();
                sleepSegments.push(currentSegment);
                currentSegment = null;
                renderTimeline();
            }
        });

        // è®¡æ—¶å™¨
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                monitorTimeEl.textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡æ³¢å³°é¢‘ç‡
                if (minutes > 0 && minutes % 1 === 0) {
                    updatePeakFrequency();
                }
            }, 1000);
        }

        // åˆ†æéŸ³é¢‘æ•°æ®
        function analyzeAudio() {
            if (!isRecording || !analyser) return;
            
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const timeDomainData = new Uint8Array(bufferLength);
            
            function processAudio() {
                if (!isRecording) return;
                
                // è·å–é¢‘ç‡æ•°æ®
                analyser.getByteFrequencyData(dataArray);
                
                // è·å–æ—¶åŸŸæ•°æ®ç”¨äºæ³¢å³°æ£€æµ‹
                analyser.getByteTimeDomainData(timeDomainData);
                
                // è®¡ç®—å¹³å‡éŸ³é‡
                let sum = 0;
                for (let i = 0; i < bufferLength; i++) {
                    sum += dataArray[i];
                }
                const average = sum / bufferLength;
                const soundLevel = Math.min(100, Math.round((average / 128) * 100));
                
                // æ›´æ–°å£°éŸ³å¼ºåº¦æ˜¾ç¤º
                soundLevelEl.textContent = `${soundLevel}%`;
                
                // æ£€æµ‹æ³¢å³°
                detectPeaks(timeDomainData);
                
                // ç»˜åˆ¶éŸ³é¢‘æ³¢å½¢
                drawWaveform(timeDomainData);
                
                // åˆ†æç¡çœ çŠ¶æ€
                analyzeSleepState();
                
                // ç»§ç»­å¤„ç†ä¸‹ä¸€å¸§
                requestAnimationFrame(processAudio);
            }
            
            processAudio();
        }

        // æ£€æµ‹æ³¢å³°
        function detectPeaks(dataArray) {
            const threshold = 128; // é˜ˆå€¼
            let peakDetected = false;
            
            for (let i = 1; i < dataArray.length - 1; i++) {
                // ç®€å•çš„æ³¢å³°æ£€æµ‹ï¼šå½“å‰å€¼å¤§äºå‰åå€¼ä¸”è¶…è¿‡é˜ˆå€¼
                if (dataArray[i] > threshold && 
                    dataArray[i] > dataArray[i - 1] && 
                    dataArray[i] > dataArray[i + 1]) {
                    
                    if (!peakDetected) {
                        peakCount++;
                        peakDetected = true;
                        
                        // è®°å½•æ³¢å³°é«˜åº¦
                        if (currentSegment) {
                            currentSegment.peaks.push({
                                time: Date.now(),
                                amplitude: dataArray[i]
                            });
                        }
                    }
                } else {
                    peakDetected = false;
                }
            }
            
            // è®°å½•æ¯åˆ†é’Ÿçš„æ³¢å³°æ•°
            const currentMinute = Math.floor((Date.now() - startTime) / 60000);
            if (!lastMinutePeaks[currentMinute]) {
                lastMinutePeaks[currentMinute] = 0;
            }
            lastMinutePeaks[currentMinute] = peakCount;
        }

        // æ›´æ–°æ³¢å³°é¢‘ç‡æ˜¾ç¤º
        function updatePeakFrequency() {
            const currentMinute = Math.floor((Date.now() - startTime) / 60000);
            
            // è®¡ç®—æœ€è¿‘ä¸€åˆ†é’Ÿçš„æ³¢å³°æ•°
            if (lastMinutePeaks.length > 0) {
                const recentPeaks = lastMinutePeaks.slice(-2); // å–æœ€è¿‘2åˆ†é’Ÿçš„æ•°æ®
                peaksPerMinute = Math.round(recentPeaks.reduce((a, b) => a + b, 0) / recentPeaks.length);
                
                peakFrequencyEl.textContent = `${peaksPerMinute} /åˆ†é’Ÿ`;
            }
        }

        // åˆ†æç¡çœ çŠ¶æ€
        function analyzeSleepState() {
            if (!currentSegment) return;
            
            // è·å–æœ€è¿‘30ç§’çš„æ³¢å³°æ•°æ®
            const recentPeaks = currentSegment.peaks.filter(
                peak => Date.now() - peak.time < 30000
            );
            
            // è®¡ç®—æ³¢å³°é«˜åº¦å˜åŒ–ï¼ˆç”¨äºåˆ¤æ–­æµ…ç¡ï¼‰
            let amplitudeVariation = 0;
            if (recentPeaks.length > 1) {
                const amplitudes = recentPeaks.map(p => p.amplitude);
                const avg = amplitudes.reduce((a, b) => a + b, 0) / amplitudes.length;
                const variance = amplitudes.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / amplitudes.length;
                amplitudeVariation = Math.sqrt(variance);
            }
            
            let newStatus;
            
            // æ£€æµ‹æ˜¯å¦æœ‰äººè§¦ç¢°æ—¶é—´è½´åŒºåŸŸï¼ˆæ¨¡æ‹Ÿï¼‰
            if (touchDetected) {
                newStatus = STATUS.AWAKE;
                touchDetected = false; // é‡ç½®
            }
            // æ ¹æ®æ³¢å³°é¢‘ç‡åˆ¤æ–­çŠ¶æ€
            else if (peaksPerMinute >= 40) {
                newStatus = STATUS.AWAKE;
            } else if (peaksPerMinute <= 20) {
                newStatus = DEEP_SLEEP;
            } else {
                // æ³¢å³°é¢‘ç‡åœ¨20-40ä¹‹é—´ï¼Œæ ¹æ®æ³¢å³°é«˜åº¦å˜åŒ–åˆ¤æ–­æµ…ç¡æˆ–è‹é†’
                if (amplitudeVariation > 15) { // æ³¢å³°é«˜åº¦å˜åŒ–å¤§
                    newStatus = STATUS.LIGHT_SLEEP;
                } else {
                    newStatus = STATUS.AWAKE;
                }
            }
            
            // å¦‚æœçŠ¶æ€æ”¹å˜ï¼Œä¿å­˜å½“å‰ç‰‡æ®µå¹¶å¼€å§‹æ–°ç‰‡æ®µ
            if (currentSegment.status !== newStatus) {
                if (currentSegment.status) { // ä¸æ˜¯ç¬¬ä¸€ä¸ªç‰‡æ®µ
                    currentSegment.endTime = Date.now();
                    sleepSegments.push({...currentSegment});
                }
                
                currentSegment = {
                    startTime: Date.now(),
                    status: newStatus,
                    peaks: []
                };
                
                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                currentStatusEl.textContent = newStatus.name;
                
                // æ›´æ–°çŠ¶æ€é¢œè‰²
                switch(newStatus) {
                    case STATUS.AWAKE:
                        currentStatusEl.style.background = 'linear-gradient(90deg, #ffa502, #ffbe76)';
                        break;
                    case STATUS.LIGHT_SLEEP:
                        currentStatusEl.style.background = 'linear-gradient(90deg, #6c5ce7, #a29bfe)';
                        break;
                    case DEEP_SLEEP:
                        currentStatusEl.style.background = 'linear-gradient(90deg, #2d3436, #636e72)';
                        break;
                    default:
                        currentStatusEl.style.background = 'linear-gradient(90deg, #ff4757, #ff6b81)';
                }
                
                // é‡æ–°æ¸²æŸ“æ—¶é—´è½´
                renderTimeline();
            }
        }

        // ç»˜åˆ¶éŸ³é¢‘æ³¢å½¢
        function drawWaveform(dataArray) {
            ctx.clearRect(0, 0, waveCanvas.width, waveCanvas.height);
            
            // è®¾ç½®æ³¢å½¢æ ·å¼
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#00b4db';
            ctx.beginPath();
            
            const sliceWidth = waveCanvas.width * 1.0 / dataArray.length;
            let x = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * waveCanvas.height / 2;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                
                x += sliceWidth;
            }
            
            ctx.lineTo(waveCanvas.width, waveCanvas.height / 2);
            ctx.stroke();
            
            // ç»˜åˆ¶æ¸å˜èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, waveCanvas.height);
            gradient.addColorStop(0, 'rgba(0, 180, 219, 0.3)');
            gradient.addColorStop(1, 'rgba(0, 180, 219, 0.1)');
            
            ctx.fillStyle = gradient;
            ctx.fill();
        }

        // æ¸²æŸ“æ—¶é—´è½´
        function renderTimeline() {
            timelineCtx.clearRect(0, 0, timelineCtx.canvas.width, timelineCtx.canvas.height);
            
            if (sleepSegments.length === 0 && !currentSegment) {
                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                timelineCtx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                timelineCtx.font = '16px Arial';
                timelineCtx.textAlign = 'center';
                timelineCtx.fillText('å¼€å§‹ç›‘æµ‹åï¼Œç¡çœ çŠ¶æ€å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ', 
                    timelineCtx.canvas.width / 2, timelineCtx.canvas.height / 2);
                return;
            }
            
            const allSegments = [...sleepSegments];
            if (currentSegment) {
                allSegments.push({
                    ...currentSegment,
                    endTime: Date.now()
                });
            }
            
            const totalDuration = allSegments.length > 0 ? 
                Date.now() - allSegments[0].startTime : 0;
            
            // ç»˜åˆ¶æ—¶é—´è½´èƒŒæ™¯
            timelineCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            timelineCtx.fillRect(0, 0, timelineCtx.canvas.width, timelineCtx.canvas.height);
            
            // ç»˜åˆ¶æ¯ä¸ªç‰‡æ®µ
            allSegments.forEach(segment => {
                const segmentStart = segment.startTime - allSegments[0].startTime;
                const segmentEnd = segment.endTime - allSegments[0].startTime;
                
                const x1 = (segmentStart / totalDuration) * timelineCtx.canvas.width;
                const x2 = (segmentEnd / totalDuration) * timelineCtx.canvas.width;
                const width = x2 - x1;
                
                // ç»˜åˆ¶ç‰‡æ®µ
                timelineCtx.fillStyle = segment.status.color;
                timelineCtx.fillRect(x1, 0, width, timelineCtx.canvas.height);
                
                // æ·»åŠ åˆ†éš”çº¿
                timelineCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                timelineCtx.lineWidth = 1;
                timelineCtx.beginPath();
                timelineCtx.moveTo(x2, 0);
                timelineCtx.lineTo(x2, timelineCtx.canvas.height);
                timelineCtx.stroke();
            });
            
            // æ·»åŠ æ—¶é—´åˆ»åº¦
            const hours = Math.ceil(totalDuration / 3600000);
            for (let i = 0; i <= hours; i++) {
                const x = (i / hours) * timelineCtx.canvas.width;
                
                timelineCtx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                timelineCtx.font = '12px Arial';
                timelineCtx.textAlign = 'center';
                timelineCtx.fillText(`${i}h`, x, timelineCtx.canvas.height - 5);
            }
        }

        // ç‚¹å‡»æ—¶é—´è½´æŸ¥çœ‹è¯¦æƒ…
        timelineCtx.canvas.addEventListener('click', (e) => {
            // æ ‡è®°ä¸ºè§¦ç¢°ï¼ˆæ¨¡æ‹Ÿæœ‰äººè§¦ç¢°é¡µé¢ï¼‰
            touchDetected = true;
            
            const rect = timelineCtx.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            
            // æ‰¾åˆ°ç‚¹å‡»çš„ç‰‡æ®µ
            const allSegments = [...sleepSegments];
            if (currentSegment) {
                allSegments.push({
                    ...currentSegment,
                    endTime: Date.now()
                });
            }
            
            const totalDuration = allSegments.length > 0 ? 
                Date.now() - allSegments[0].startTime : 0;
            
            const clickTime = (x / timelineCtx.canvas.width) * totalDuration;
            const clickTimestamp = allSegments[0].startTime + clickTime;
            
            let clickedSegment = null;
            for (const segment of allSegments) {
                if (clickTimestamp >= segment.startTime && clickTimestamp <= segment.endTime) {
                    clickedSegment = segment;
                    break;
                }
            }
            
            if (clickedSegment) {
                // æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                const startTime = new Date(clickedSegment.startTime);
                const endTime = new Date(clickedSegment.endTime);
                const duration = Math.round((clickedSegment.endTime - clickedSegment.startTime) / 1000);
                
                let details = `
                    <div style="margin-bottom: 15px;">
                        <h4 style="color: ${clickedSegment.status.color}; margin-bottom: 10px;">
                            ${clickedSegment.status.name} çŠ¶æ€
                        </h4>
                        <p><strong>å¼€å§‹æ—¶é—´:</strong> ${startTime.toLocaleTimeString()}</p>
                        <p><strong>ç»“æŸæ—¶é—´:</strong> ${endTime.toLocaleTimeString()}</p>
                        <p><strong>æŒç»­æ—¶é—´:</strong> ${duration} ç§’</p>
                        <p><strong>æ³¢å³°æ•°é‡:</strong> ${clickedSegment.peaks.length}</p>
                    </div>
                `;
                
                // æ·»åŠ çŠ¶æ€æè¿°
                if (clickedSegment.status === STATUS.AWAKE) {
                    details += `<p><strong>çŠ¶æ€æè¿°:</strong> æ‚¨å¤„äºæ¸…é†’çŠ¶æ€ï¼Œå‘¼å¸å’Œèº«ä½“æ´»åŠ¨è¾ƒé¢‘ç¹ã€‚</p>`;
                } else if (clickedSegment.status === STATUS.LIGHT_SLEEP) {
                    details += `<p><strong>çŠ¶æ€æè¿°:</strong> æ‚¨å¤„äºæµ…ç¡çŠ¶æ€ï¼Œå®¹æ˜“é†’æ¥ï¼Œå¯èƒ½æœ‰æ¢¦å¢ƒã€‚</p>`;
                } else if (clickedSegment.status === DEEP_SLEEP) {
                    details += `<p><strong>çŠ¶æ€æè¿°:</strong> æ‚¨å¤„äºæ·±åº¦ç¡çœ çŠ¶æ€ï¼Œèº«ä½“å®Œå…¨æ”¾æ¾ï¼Œå‘¼å¸å¹³ç¨³ã€‚</p>`;
                } else {
                    details += `<p><strong>çŠ¶æ€æè¿°:</strong> ç³»ç»Ÿæ­£åœ¨åˆ†ææ‚¨çš„ç¡çœ çŠ¶æ€ã€‚</p>`;
                }
                
                detailsContent.innerHTML = details;
            }
            
            // é«˜äº®æ˜¾ç¤ºç‚¹å‡»çš„åŒºåŸŸ
            timelineCtx.strokeStyle = '#ffffff';
            timelineCtx.lineWidth = 3;
            timelineCtx.strokeRect(x - 2, 0, 4, timelineCtx.canvas.height);
            
            // 3ç§’åç§»é™¤é«˜äº®
            setTimeout(() => {
                renderTimeline();
            }, 3000);
        });

        // åˆå§‹æ¸²æŸ“æ—¶é—´è½´
        renderTimeline();
        
        // é¡µé¢å¸è½½æ—¶åœæ­¢ç›‘æµ‹
        window.addEventListener('beforeunload', () => {
            if (isRecording) {
                stopBtn.click();
            }
        });
    </script>
</body>
</html>
